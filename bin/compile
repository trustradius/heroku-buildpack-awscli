#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e
# set -x

BUILD_DIR=$1
CACHE_DIR=$2
LP_DIR=`cd $(dirname $0); cd ..; pwd`
BUILDPACK_DIR="$(dirname $(dirname $0))"

AWS_CLI_URL="https://s3.amazonaws.com/aws-cli/awscli-bundle.zip"

echo "-----> Fetching AWS CLI into slug"
curl --progress-bar -o /tmp/awscli-bundle.zip $AWS_CLI_URL
unzip -qq -d "$BUILD_DIR/vendor" /tmp/awscli-bundle.zip

#cleaning up...
rm -rf /tmp/awscli*

echo "-----> Installing & Configuring awscli"

INSTALL_DIR="$BUILD_DIR/vendor/awscli"
chmod +x $BUILD_DIR/vendor/awscli-bundle/install
$BUILD_DIR/vendor/awscli-bundle/install -i $INSTALL_DIR
chmod u+x $INSTALL_DIR/bin/aws
export PATH="$PATH:$INSTALL_DIR/bin"
aws configure set region "us-east-1"

echo "-----> aws cli installation done"
